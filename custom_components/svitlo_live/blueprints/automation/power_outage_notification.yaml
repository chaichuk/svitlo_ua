blueprint:
  name: "–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞"
  description: "–ù–∞–¥—Å–∏–ª–∞—î push-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —Ä–æ–∑–∫–ª–∞–¥–æ–º –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Å–≤—ñ—Ç–ª–∞ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ"
  domain: automation
  input:
    schedule_calendar:
      name: –ö–∞–ª–µ–Ω–¥–∞—Ä –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
      description: –í–∏–±–µ—Ä—ñ—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä –∑ —Ä–æ–∑–∫–ª–∞–¥–æ–º –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Å–≤—ñ—Ç–ª–∞
      selector:
        entity:
          domain: calendar
    
    run_time:
      name: –ß–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      description: –ß–∞—Å –∫–æ–ª–∏ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —â–æ–¥–Ω—è
      default: "07:00:00"
      selector:
        time:
    
    mobile_targets:
      name: –ú–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó
      description: –í–∏–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∞–±–æ –∫—ñ–ª—å–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      default: []
      selector:
        device:
          integration: mobile_app
          multiple: true
    
    title_text:
      name: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      default: "‚ö°–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–µ–Ω–µ—Ä–≥—ñ—ó"
      selector:
        text:

mode: single

trigger:
  - platform: time
    at: !input run_time

variables:
  cal_entity: !input schedule_calendar
  mobile_targets: !input mobile_targets
  title_text: !input title_text

action:
  # 1) –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–¥—ñ—ó –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
  - service: calendar.get_events
    target:
      entity_id: !input schedule_calendar
    data:
      start_date_time: "{{ today_at('00:00').isoformat() }}"
      end_date_time: "{{ today_at('23:59:59').isoformat() }}"
    response_variable: cal_resp

  # 2) –ì–æ—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  - variables:
      # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–¥—ñ—ó –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      raw_events: >-
        {% set r = cal_resp %}
        {% set k = cal_entity %}
        {% if r is mapping and (k in r) and (r[k] is mapping) and ('events' in r[k]) %}
          {{ r[k]['events'] }}
        {% else %}
          {{ [] }}
        {% endif %}
      
      # –°–æ—Ä—Ç—É—î–º–æ –ø–æ–¥—ñ—ó –∑–∞ —á–∞—Å–æ–º –ø–æ—á–∞—Ç–∫—É
      evs_sorted: "{{ raw_events | sort(attribute='start') }}"
      
      today_str: "{{ now().strftime('%d.%m.%Y') }}"
      
      # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      body: >-
        {% if evs_sorted | count == 0 -%}
        ‚úÖ –°—å–æ–≥–æ–¥–Ω—ñ ({{ today_str }}) –ø–ª–∞–Ω–æ–≤–∏—Ö –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Å–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î!
        {%- else -%}
        üìÖ –†–æ–∑–∫–ª–∞–¥ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ ({{ today_str }}):

        {% for e in evs_sorted -%}
        {%- set title = e.summary | default(e.title, true) | default('–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞') -%}
        {%- set sdt = (as_datetime(e.start) if e.start is defined else none) -%}
        {%- set edt = (as_datetime(e.end) if e.end is defined else none) -%}
        {%- set s_loc = sdt.astimezone(now().tzinfo) if sdt else none -%}
        {%- set e_loc = edt.astimezone(now().tzinfo) if edt else none -%}
        üïê  {% if s_loc and e_loc %}{{ s_loc.strftime('%H:%M') }} - {{ e_loc.strftime('%H:%M') }}{% elif s_loc %}–∑ {{ s_loc.strftime('%H:%M') }}{% else %}—á–∞—Å –Ω–µ –≤–∫–∞–∑–∞–Ω–æ{% endif %}{% if title != '–í—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞' %} ({{ title }}){% endif %}

        {% endfor -%}
        {%- endif -%}

  # 3) –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –Ω–∞ –≤–∏–±—Ä–∞–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó
  - choose:
      # –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω—ñ –º–æ–±—ñ–ª—å–Ω—ñ –ø—Ä–∏—Å—Ç—Ä–æ—ó
      - conditions: "{{ mobile_targets | length > 0 }}"
        sequence:
          - repeat:
              for_each: !input mobile_targets
              sequence:
                - variables:
                    dev_name: "{{ device_attr(repeat.item, 'name') | default('unknown') }}"
                    svc_name: "{{ 'notify.mobile_app_' ~ (dev_name | lower | replace(' ', '_') | replace('-', '_')) }}"
                - service: "{{ svc_name }}"
                  data:
                    title: "{{ title_text }}"
                    message: "{{ body }}"
                    data:
                      notification_icon: "mdi:power-plug-off"
                      priority: high
    # –Ø–∫—â–æ –Ω–µ –≤–∏–±—Ä–∞–Ω–æ –∂–æ–¥–Ω–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é
    default:
      - service: persistent_notification.create
        data:
          title: "{{ title_text }}"
          message: "{{ body }}"
